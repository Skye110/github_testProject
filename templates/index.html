<!DOCTYPE html>
<html lang="mn">
<head>
<meta charset="utf-8" />
<title>UB Route Finder</title>
<link rel="stylesheet" href="/static/style.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div id="map"></div>

<div id="control-panel">
    <h2>ğŸ—ºï¸ Route Finder</h2>

    <div class="control-group">
        <label for="algSelect">ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼</label>
        <select id="algSelect">
            <option value="dijkstra">Dijkstra</option>
            <option value="bfs">BFS</option>
            <option value="dfs">DFS</option>
        </select>
    </div>

    <div class="control-group">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="trafficToggle" style="width: auto; cursor: pointer;">
            <span>ğŸš¦ Ğ—Ğ°Ğ¼Ñ‹Ğ½ Ñ…Ó©Ğ´Ó©Ğ»Ğ³Ó©Ó©Ğ½</span>
        </label>
    </div>

    <div class="button-group">
        <button id="runReplace" class="btn-primary">â–¶ï¸ Ğ“Ò¯Ğ¹Ñ†ÑÑ‚Ğ³ÑÑ…</button>
        <button id="compare" class="btn-success">âš–ï¸ Ğ¥Ğ°Ñ€ÑŒÑ†ÑƒÑƒĞ»Ğ°Ñ…</button>
        <button id="clear" class="btn-danger">ğŸ—‘ï¸ Ğ¦ÑĞ²ÑÑ€Ğ»ÑÑ…</button>
    </div>

    <div id="status" class="status-box">
        <div id="result">ğŸ“ Ğ­Ñ…Ğ»ÑĞ», Ğ´Ğ°Ñ€Ğ°Ğ° Ğ¢Ó©Ğ³ÑĞ³Ó©Ğ» ÑĞ¾Ğ½Ğ³Ğ¾Ğ½Ğ¾ ÑƒÑƒ</div>
        <div id="progress" style="display:none; margin-top: 8px;">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="progressText"></div>
        </div>
    </div>

    <div class="panel-block">
        <h4>ğŸ“Š Ò®Ñ€ Ğ´Ò¯Ğ½</h4>
        <div id="savedList" class="saved-list"></div>
    </div>

    <div class="panel-block">
        <h4>â±ï¸ Ğ¥ÑƒĞ³Ğ°Ñ†Ğ°Ğ°</h4>
        <canvas id="perfChart" width="280" height="140"></canvas>
    </div>
</div>

<script>
const map = L.map('map').setView([47.918, 106.917], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
    maxZoom: 18,
    attribution: 'Â© OpenStreetMap'
}).addTo(map);

let markers = [];
let routeLayers = {};
let resultsStore = {};

const colors = {
    'Dijkstra': '#e74c3c',
    'BFS': '#3498db',
    'DFS': '#2ecc71'
};

document.getElementById('trafficToggle').onchange = function() {
    // Just visual feedback, backend handles traffic
};

const ctx = document.getElementById('perfChart').getContext('2d');
const chart = new Chart(ctx, { 
    type: 'bar', 
    data: { 
        labels: [], 
        datasets: [{ 
            label: 'Ğ¼Ñ', 
            data: [], 
            backgroundColor: [] 
        }] 
    }, 
    options: { 
        responsive: true, 
        maintainAspectRatio: false,
        scales: { 
            y: { 
                beginAtZero: true, 
                ticks: { color: '#d3e8ff' }, 
                grid: { color: 'rgba(255,255,255,0.1)' } 
            },
            x: { 
                ticks: { color: '#d3e8ff' }, 
                grid: { color: 'rgba(255,255,255,0.1)' } 
            }
        },
        plugins: { legend: { display: false } }
    } 
});

function updateChart() {
    const keys = Object.keys(resultsStore);
    chart.data.labels = keys;
    chart.data.datasets[0].data = keys.map(k => resultsStore[k].time || 0);
    chart.data.datasets[0].backgroundColor = keys.map(k => colors[k]);
    chart.update();
}

function showProgress(text) {
    document.getElementById('progress').style.display = 'block';
    document.getElementById('progressText').innerText = text;
    let width = 0;
    const fill = document.getElementById('progressFill');
    const interval = setInterval(() => { 
        width += 5; 
        if(width > 90) width = 90; 
        fill.style.width = width + '%'; 
    }, 300);
    return interval;
}

function hideProgress(interval) {
    clearInterval(interval);
    document.getElementById('progressFill').style.width = '100%';
    setTimeout(() => { 
        document.getElementById('progress').style.display = 'none'; 
        document.getElementById('progressFill').style.width = '0%'; 
    }, 500);
}

function addMarker(latlng, label) {
    const icon = label === 'Ğ­Ñ…Ğ»ÑĞ»' ? 'ğŸŸ¢' : 'ğŸ”´';
    const m = L.marker(latlng, {
        icon: L.divIcon({ 
            className: 'custom-marker', 
            html: `<div style="font-size: 24px;">${icon}</div>`, 
            iconSize: [30, 30], 
            iconAnchor: [15, 15] 
        })
    }).addTo(map).bindPopup(`<b>${label}</b>`).openPopup();
    markers.push(m);
}

map.on('click', e => {
    if(markers.length === 0) { 
        addMarker(e.latlng, 'Ğ­Ñ…Ğ»ÑĞ»'); 
        document.getElementById('result').innerText = 'âœ… Ğ¢Ó©Ğ³ÑĞ³Ó©Ğ» ÑĞ¾Ğ½Ğ³Ğ¾Ğ½Ğ¾ ÑƒÑƒ'; 
        return; 
    }
    if(markers.length === 1) { 
        addMarker(e.latlng, 'Ğ¢Ó©Ğ³ÑĞ³Ó©Ğ»'); 
        document.getElementById('result').innerText = 'âœ… "Ğ“Ò¯Ğ¹Ñ†ÑÑ‚Ğ³ÑÑ…" Ğ´Ğ°Ñ€Ğ½Ğ° ÑƒÑƒ'; 
        return; 
    }
    markers.forEach(m => map.removeLayer(m)); 
    markers = []; 
    addMarker(e.latlng, 'Ğ­Ñ…Ğ»ÑĞ»'); 
    document.getElementById('result').innerText = 'ğŸ”„ Ğ¢Ó©Ğ³ÑĞ³Ó©Ğ» ÑĞ¾Ğ½Ğ³Ğ¾Ğ½Ğ¾ ÑƒÑƒ';
});

function renderSavedList() {
    const box = document.getElementById('savedList'); 
    box.innerHTML = '';
    const keys = Object.keys(resultsStore);
    if(keys.length === 0) { 
        box.innerHTML = '<div style="color: #888; text-align: center; padding: 12px;">Ò®Ñ€ Ğ´Ò¯Ğ½ Ğ°Ğ»Ğ³Ğ°</div>'; 
        return; 
    }
    keys.forEach(alg => {
        const r = resultsStore[alg];
        const row = document.createElement('div'); 
        row.className = 'saved-row';
        const time = r.time ? `â±ï¸ ${r.time}ms` : '';
        const dist = r.distance ? ` | ğŸ“ ${Math.round(r.distance)}Ğ¼` : '';
        const steps = r.steps ? ` | ğŸ‘£ ${r.steps}` : '';
        row.innerHTML = `
            <div class="saved-left">
                <span class="swatch" style="background:${r.color}"></span>
                <div>
                    <div class="lbl">${alg}</div>
                    <div class="meta">${time}${steps}${dist}</div>
                </div>
            </div>
            <div class="saved-actions">
                <button data-alg="${alg}" class="toggle-btn btn-sm">${r.visible ? 'ğŸ‘ï¸':'ğŸ‘ï¸â€ğŸ—¨ï¸'}</button>
                <button data-alg="${alg}" class="delete-btn btn-sm">Ã—</button>
            </div>`;
        box.appendChild(row);
    });
    box.querySelectorAll('.toggle-btn').forEach(btn => { 
        btn.onclick = e => { 
            const alg = e.target.dataset.alg; 
            resultsStore[alg].visible = !resultsStore[alg].visible; 
            redrawAll(); 
            renderSavedList();
        }; 
    });
    box.querySelectorAll('.delete-btn').forEach(btn => { 
        btn.onclick = e => { 
            const alg = e.target.dataset.alg; 
            if(routeLayers[alg]) routeLayers[alg].forEach(l => map.removeLayer(l)); 
            delete routeLayers[alg]; 
            delete resultsStore[alg]; 
            renderSavedList(); 
            updateChart(); 
        }; 
    });
}

function redrawAll() {
    for(const alg in routeLayers) { 
        routeLayers[alg].forEach(l => map.removeLayer(l)); 
    }
    routeLayers = {};
    for(const alg in resultsStore) {
        if(!resultsStore[alg].visible) continue;
        const r = resultsStore[alg];
        if(!r.path || r.path.length === 0) continue;
        routeLayers[alg] = [];
        const latlngs = r.path.map(pt => [pt[1], pt[0]]);
        const poly = L.polyline(latlngs, { 
            color: r.color, 
            weight: 5, 
            opacity: 0.8 
        }).addTo(map);
        poly.bindPopup(`<b>${alg}</b><br>â±ï¸ ${r.time}ms<br>ğŸ“ ${Math.round(r.distance)}Ğ¼<br>ğŸ‘£ ${r.steps}`);
        routeLayers[alg].push(poly);
    }
}

async function callRoute(alg, useTraffic) {
    if(markers.length < 2) { 
        alert('âš ï¸ Ğ­Ñ…Ğ»ÑĞ» Ğ±Ğ¾Ğ»Ğ¾Ğ½ Ñ‚Ó©Ğ³ÑĞ³Ó©Ğ» Ğ±Ğ°Ğ¹Ñ…Ğ³Ò¯Ğ¹'); 
        return null; 
    }
    const src = markers[0].getLatLng(), dst = markers[1].getLatLng();
    const params = new URLSearchParams();
    params.set('src', `${src.lng},${src.lat}`);
    params.set('dst', `${dst.lng},${dst.lat}`);
    params.set('alg', alg);
    params.set('traffic', useTraffic ? 'true' : 'false');
    const res = await fetch('/route?' + params);
    if(!res.ok) { 
        const txt = await res.text().catch(() => res.statusText); 
        throw new Error(txt || res.statusText); 
    }
    return res.json();
}

document.getElementById('runReplace').onclick = async () => {
    const alg = document.getElementById('algSelect').value;
    const useTraffic = document.getElementById('trafficToggle').checked;
    const algName = alg.toUpperCase();
    const progressInterval = showProgress(`${algName}...`);
    document.getElementById('result').innerText = `â³ ${algName}...`;
    try {
        const data = await callRoute(alg, useTraffic);
        hideProgress(progressInterval);
        if(!data) return;
        if(data.error) { 
            document.getElementById('result').innerHTML = `<strong style="color: #f5424e;">âš ï¸ ${data.message || data.error}</strong>`; 
            return; 
        }
        const displayName = data.algorithm;
        resultsStore[displayName] = { 
            algorithm: displayName, 
            path: data.path, 
            steps: data.steps, 
            distance: data.distance || 0, 
            time: data.time || 0, 
            visible: true, 
            color: colors[displayName] || '#888' 
        };
        renderSavedList(); 
        redrawAll(); 
        updateChart();
        markers.forEach(m => map.removeLayer(m)); 
        markers = [];
        document.getElementById('result').innerHTML = `<strong style="color: #4caf50;">âœ” ${displayName}</strong> â€” â±ï¸ ${data.time}ms | ğŸ‘£ ${data.steps} | ğŸ“ ${Math.round(data.distance)}Ğ¼`;
    } catch (err) { 
        hideProgress(progressInterval); 
        alert('âŒ ' + err.message); 
        document.getElementById('result').innerHTML = `<strong style="color: #f5424e;">ĞĞ»Ğ´Ğ°Ğ°:</strong> ${err.message}`; 
    }
};

document.getElementById('compare').onclick = async () => {
    if(markers.length < 2) { 
        alert('âš ï¸ Ğ­Ñ…Ğ»ÑĞ» Ğ±Ğ¾Ğ»Ğ¾Ğ½ Ñ‚Ó©Ğ³ÑĞ³Ó©Ğ» Ğ±Ğ°Ğ¹Ñ…Ğ³Ò¯Ğ¹'); 
        return; 
    }
    const useTraffic = document.getElementById('trafficToggle').checked;
    const progressInterval = showProgress('âš–ï¸ Ğ¥Ğ°Ñ€ÑŒÑ†ÑƒÑƒĞ»Ğ¶ Ğ±Ğ°Ğ¹Ğ½Ğ°...');
    document.getElementById('result').innerText = 'â³ Ğ¥Ğ°Ñ€ÑŒÑ†ÑƒÑƒĞ»Ğ°Ğ»Ñ‚...';
    try {
        const src = markers[0].getLatLng(), dst = markers[1].getLatLng();
        const url = `/compare?src=${src.lng},${src.lat}&dst=${dst.lng},${dst.lat}&traffic=${useTraffic ? 'true' : 'false'}`;
        const res = await fetch(url);
        hideProgress(progressInterval);
        if(!res.ok) { 
            const t = await res.text().catch(() => res.statusText); 
            throw new Error(t || res.statusText); 
        }
        const arr = await res.json();
        for(const r of arr) {
            if(!r || r.error) continue;
            resultsStore[r.algorithm] = { 
                algorithm: r.algorithm, 
                path: r.path, 
                steps: r.steps, 
                distance: r.distance || 0, 
                time: r.time || 0, 
                visible: true, 
                color: colors[r.algorithm] || '#888' 
            };
        }
        markers.forEach(m => map.removeLayer(m)); 
        markers = [];
        renderSavedList(); 
        redrawAll(); 
        updateChart();
        const times = arr.filter(r => !r.error).map(r => `${r.algorithm}: ${r.time}ms`).join(', ');
        document.getElementById('result').innerHTML = `<strong style="color: #4caf50;">âœ” Ğ”ÑƒÑƒÑĞ»Ğ°Ğ°</strong><br><small>${times}</small>`;
    } catch(err) { 
        hideProgress(progressInterval); 
        alert('âŒ ' + err.message); 
        document.getElementById('result').innerHTML = `<strong style="color: #f5424e;">ĞĞ»Ğ´Ğ°Ğ°:</strong> ${err.message}`; 
    }
};

document.getElementById('clear').onclick = () => {
    for(const alg in routeLayers) routeLayers[alg].forEach(l => map.removeLayer(l));
    routeLayers = {}; 
    resultsStore = {}; 
    renderSavedList();
    markers.forEach(m => map.removeLayer(m)); 
    markers = [];
    chart.data.labels = []; 
    chart.data.datasets[0].data = []; 
    chart.update();
    document.getElementById('result').innerText = 'ğŸ—‘ï¸ Ğ¦ÑĞ²ÑÑ€Ğ»ÑĞ³Ğ´ÑÑĞ½';
};

renderSavedList(); 
updateChart();
</script>
</body>
</html>