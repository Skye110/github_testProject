<!DOCTYPE html>
<html lang="mn">
<head>
<meta charset="utf-8" />
<title>UB Route Finder ‚Äî Traffic Flow</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div id="map"></div>

<div id="control-panel">
    <h2>üó∫Ô∏è –ê–ª–≥–æ—Ä–∏—Ç–º –•–∞—Ä—å—Ü—É—É–ª–∞—Ö</h2>

    <div class="control-group">
        <label for="algSelect">–ê–ª–≥–æ—Ä–∏—Ç–º</label>
        <select id="algSelect">
            <option value="dijkstra">Dijkstra</option>
            <option value="bfs">BFS</option>
            <option value="dfs">DFS</option>
        </select>
    </div>

    <div class="control-group">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="trafficToggle" style="width: auto; cursor: pointer;">
            <span>üö¶ –ó–∞–º—ã–Ω —Ö”©–¥”©–ª–≥”©”©–Ω–∏–π –∞—á–∞–∞–ª–ª—ã–≥ —Ç–æ–æ—Ü–æ—Ö</span>
        </label>
        <small style="color: #90caf9; font-size: 11px; margin-top: 4px; display: block;">
            –ò–¥—ç–≤—Ö–∂“Ø“Ø–ª—Å—ç–Ω “Ø–µ–¥ –∑–∞—Ä–∏–º –∑–∞–º –∏–ª“Ø“Ø —É–¥–∞–∞–Ω –±–æ–ª–Ω–æ
        </small>
    </div>

    <div class="button-group">
        <button id="runReplace" class="btn-primary">‚ñ∂Ô∏è –ì“Ø–π—Ü—ç—Ç–≥—ç—Ö</button>
        <button id="compare" class="btn-success">‚öñÔ∏è –•–∞—Ä—å—Ü—É—É–ª–∞—Ö (3 –∞–ª–≥–æ—Ä–∏—Ç–º)</button>
        <button id="clear" class="btn-danger">üóëÔ∏è –¶—ç–≤—ç—Ä–ª—ç—Ö</button>
    </div>

    <div id="status" class="status-box">
        <div id="result">üìç –ì–∞–∑—Ä—ã–Ω –∑—É—Ä–∞–≥ –¥—ç—ç—Ä –≠—Ö–ª—ç–ª, –¥–∞—Ä–∞–∞ –¢”©–≥—Å–≥”©–ª-–∏–π–≥ –¥–∞—Ä–Ω–∞ —É—É</div>
        <div id="progress" style="display:none; margin-top: 8px;">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="progressText" style="font-size: 12px; margin-top: 4px; text-align: center;"></div>
        </div>
    </div>

    <div class="panel-block">
        <h4>üìä –•–∞–¥–≥–∞–ª—Å–∞–Ω “Ø—Ä –¥“Ø–Ω</h4>
        <div id="savedList" class="saved-list"></div>
    </div>

    <div class="panel-block">
        <h4>‚è±Ô∏è –ì“Ø–π—Ü—ç—Ç–≥—ç–ª–∏–π–Ω —Ö–∞—Ä—å—Ü—É—É–ª–∞–ª—Ç</h4>
        <canvas id="perfChart" width="280" height="140"></canvas>
    </div>
</div>

<script>
/* Map initialization */
const map = L.map('map').setView([47.918, 106.917], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
    maxZoom: 18,
    attribution: '¬© OpenStreetMap contributors'
}).addTo(map);

let markers = [];
let routeLayers = {};
let resultsStore = {};
const palette = ['#e6194b','#3cb44b','#ffe119','#4363d8','#f58231','#911eb4','#46f0f0','#f032e6','#d2f53c','#fabebe'];

function colorForAlg(alg) {
    const colors = {
        'Dijkstra': '#e74c3c',
        'BFS': '#3498db',
        'DFS': '#2ecc71'
    };
    return colors[alg] || palette[Math.floor(Math.random() * palette.length)];
}

/* Chart.js - Performance comparison chart */
const ctx = document.getElementById('perfChart').getContext('2d');
const chart = new Chart(ctx, { 
    type: 'bar', 
    data: { 
        labels: [], 
        datasets: [{ 
            label: '–ì“Ø–π—Ü—ç—Ç–≥—ç—Ö —Ö—É–≥–∞—Ü–∞–∞ (ms)', 
            data: [], 
            backgroundColor: [] 
        }] 
    }, 
    options: { 
        responsive: true, 
        maintainAspectRatio: false,
        scales: { 
            y: { 
                beginAtZero: true,
                title: { display: true, text: '–¶–∞–≥ (–º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥)', color: '#d3e8ff' },
                ticks: { color: '#d3e8ff' },
                grid: { color: 'rgba(255,255,255,0.1)' }
            },
            x: {
                ticks: { color: '#d3e8ff' },
                grid: { color: 'rgba(255,255,255,0.1)' }
            }
        },
        plugins: {
            legend: { display: false },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const alg = context.label;
                        const r = resultsStore[alg];
                        if(r) {
                            let info = `${context.parsed.y}ms`;
                            if(r.steps) info += ` | ${r.steps} –∞–ª—Ö–∞–º`;
                            if(r.distance) info += ` | ${Math.round(r.distance)}–º`;
                            if(r.travel_time) info += ` | üö¶${Math.round(r.travel_time)}`;
                            return info;
                        }
                        return `${context.parsed.y}ms`;
                    }
                }
            }
        }
    } 
});

function updateChartFromStore() {
    const keys = Object.keys(resultsStore);
    chart.data.labels = keys;
    chart.data.datasets[0].data = keys.map(k => resultsStore[k].time || 0);
    chart.data.datasets[0].backgroundColor = keys.map(k => resultsStore[k].color);
    chart.update();
}

/* Progress indicator */
function showProgress(text) {
    document.getElementById('progress').style.display = 'block';
    document.getElementById('progressText').innerText = text;
    let width = 0;
    const fill = document.getElementById('progressFill');
    const interval = setInterval(() => {
        width += 5;
        if(width > 90) width = 90;
        fill.style.width = width + '%';
    }, 300);
    return interval;
}

function hideProgress(interval) {
    clearInterval(interval);
    const fill = document.getElementById('progressFill');
    fill.style.width = '100%';
    setTimeout(() => {
        document.getElementById('progress').style.display = 'none';
        fill.style.width = '0%';
    }, 500);
}

/* Marker behavior */
function addMarker(latlng, label) {
    const icon = label === '–≠—Ö–ª—ç–ª' ? 'üü¢' : 'üî¥';
    const m = L.marker(latlng, {
        icon: L.divIcon({
            className: 'custom-marker',
            html: `<div style="font-size: 24px;">${icon}</div>`,
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        })
    }).addTo(map).bindPopup(`<b>${label}</b>`).openPopup();
    markers.push(m);
}

map.on('click', e => {
    if(markers.length === 0) {
        addMarker(e.latlng, '–≠—Ö–ª—ç–ª');
        document.getElementById('result').innerText = '‚úÖ –≠—Ö–ª—ç–ª –±–∞–π—Ä–ª—É—É–ª—Å–∞–Ω. –¢”©–≥—Å–≥”©–ª —Å–æ–Ω–≥–æ–Ω–æ —É—É.';
        return;
    }
    if(markers.length === 1) {
        addMarker(e.latlng, '–¢”©–≥—Å–≥”©–ª');
        document.getElementById('result').innerText = '‚úÖ –¢”©–≥—Å–≥”©–ª –±–∞–π—Ä–ª—É—É–ª—Å–∞–Ω. "–ì“Ø–π—Ü—ç—Ç–≥—ç—Ö" –¥–∞—Ä–Ω–∞ —É—É.';
        return;
    }
    // Clear and start new pair
    markers.forEach(m => map.removeLayer(m)); 
    markers = []; 
    addMarker(e.latlng, '–≠—Ö–ª—ç–ª');
    document.getElementById('result').innerText = 'üîÑ –®–∏–Ω—ç —ç—Ö–ª—ç–ª –±–∞–π—Ä–ª—É—É–ª—Å–∞–Ω. –¢”©–≥—Å–≥”©–ª —Å–æ–Ω–≥–æ–Ω–æ —É—É.';
});

/* Render saved list */
function renderSavedList() {
    const box = document.getElementById('savedList'); 
    box.innerHTML = '';
    const keys = Object.keys(resultsStore);

    if(keys.length === 0) { 
        box.innerHTML = '<div style="color: #888; text-align: center; padding: 12px;">–•–∞–¥–≥–∞–ª—Å–∞–Ω “Ø—Ä –¥“Ø–Ω –∞–ª–≥–∞</div>'; 
        return; 
    }

    keys.forEach(alg => {
        const r = resultsStore[alg];
        const row = document.createElement('div'); 
        row.className = 'saved-row';
        
        const timeText = r.time ? `‚è±Ô∏è ${r.time}ms` : '';
        const distText = r.distance ? ` | üìè ${Math.round(r.distance)}–º` : '';
        const stepsText = r.steps ? ` | üë£ ${r.steps}` : '';
        const trafficText = r.traffic && r.travel_time ? ` | üö¶ ${Math.round(r.travel_time)}` : '';
        
        row.innerHTML = `
            <div class="saved-left">
                <span class="swatch" style="background:${r.color}"></span>
                <div>
                    <div class="lbl">${alg}${r.traffic ? ' üö¶' : ''}</div>
                    <div class="meta">${timeText}${stepsText}${distText}${trafficText}</div>
                </div>
            </div>
            <div class="saved-actions">
                <button data-alg="${alg}" class="toggle-btn btn-sm">${r.visible ? 'üëÅÔ∏è –ù—É—É—Ö':'üëÅÔ∏è –•–∞—Ä–∞—Ö'}</button>
                <button data-alg="${alg}" class="delete-btn btn-sm">√ó</button>
            </div>`;
        box.appendChild(row);
    });

    box.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.onclick = e => {
            const alg = e.target.dataset.alg;
            resultsStore[alg].visible = !resultsStore[alg].visible;
            e.target.innerText = resultsStore[alg].visible ? 'üëÅÔ∏è –ù—É—É—Ö':'üëÅÔ∏è –•–∞—Ä–∞—Ö';
            redrawAllVisible();
        };
    });

    box.querySelectorAll('.delete-btn').forEach(btn => {
        btn.onclick = e => {
            const alg = e.target.dataset.alg;
            if(routeLayers[alg]) routeLayers[alg].forEach(l => map.removeLayer(l));
            delete routeLayers[alg];
            delete resultsStore[alg];
            renderSavedList();
            updateChartFromStore();
        };
    });
}

/* Draw visible routes with directional arrows */
function redrawAllVisible() {
    // Clear all existing routes
    for(const alg in routeLayers) {
        routeLayers[alg].forEach(l => map.removeLayer(l));
    }
    routeLayers = {};

    for(const alg in resultsStore) {
        if(!resultsStore[alg].visible) continue;
        const r = resultsStore[alg];
        
        if(!r.path || r.path.length === 0) continue;
        
        routeLayers[alg] = [];
        
        const latlngs = r.path.map(pt => [pt[1], pt[0]]);
        
        // Main polyline
        const poly = L.polyline(latlngs, { 
            color: r.color, 
            weight: 5,
            opacity: 0.8
        }).addTo(map);
        
        // Add directional arrows to show traffic flow
        addDirectionalArrows(latlngs, r.color, alg);
        
        // Popup with path info
        const timeInfo = r.time ? `<br>‚è±Ô∏è –•—É–≥–∞—Ü–∞–∞: <strong>${r.time}ms</strong>` : '';
        const distInfo = r.distance ? `<br>üìè –ó–∞–π: <strong>${Math.round(r.distance)}–º</strong>` : '';
        const trafficInfo = r.traffic && r.travel_time ? `<br>üö¶ –ó–∞–º—ã–Ω —Ö”©–¥”©–ª–≥”©”©–Ω: <strong>${Math.round(r.travel_time)}</strong>` : '';
        poly.bindPopup(`
            <b>${alg}${r.traffic ? ' üö¶' : ''}</b>
            ${timeInfo}
            ${distInfo}
            ${trafficInfo}
            <br>üë£ –ê–ª—Ö–∞–º—É—É–¥: ${r.steps}
        `);
        
        routeLayers[alg].push(poly);
        
        // Start marker
        routeLayers[alg].push(
            L.circleMarker(latlngs[0], { 
                radius: 7, 
                fillColor: '#2ecc71', 
                color: '#fff', 
                weight: 2, 
                fillOpacity: 1 
            }).addTo(map).bindPopup('üü¢ –≠—Ö–ª—ç–ª')
        );
        
        // End marker
        routeLayers[alg].push(
            L.circleMarker(latlngs[latlngs.length-1], { 
                radius: 7, 
                fillColor: '#e74c3c', 
                color: '#fff', 
                weight: 2, 
                fillOpacity: 1 
            }).addTo(map).bindPopup('üî¥ –¢”©–≥—Å–≥”©–ª')
        );
    }
}

/* Add directional arrows along the path */
function addDirectionalArrows(latlngs, color, alg) {
    // Add arrows every N segments to show direction
    const arrowInterval = Math.max(1, Math.floor(latlngs.length / 8)); // Show ~8 arrows
    
    for(let i = arrowInterval; i < latlngs.length; i += arrowInterval) {
        const from = latlngs[i - 1];
        const to = latlngs[i];
        
        // Calculate angle between points
        const angle = Math.atan2(to[0] - from[0], to[1] - from[1]) * (180 / Math.PI);
        
        // Create arrow marker at midpoint
        const midpoint = [(from[0] + to[0]) / 2, (from[1] + to[1]) / 2];
        
        const arrowIcon = L.divIcon({
            className: 'arrow-icon',
            html: `<div style="
                width: 0; 
                height: 0; 
                border-left: 6px solid transparent;
                border-right: 6px solid transparent;
                border-bottom: 12px solid ${color};
                transform: rotate(${angle}deg);
                transform-origin: center;
                opacity: 0.9;
            "></div>`,
            iconSize: [12, 12],
            iconAnchor: [6, 6]
        });
        
        const arrow = L.marker(midpoint, { icon: arrowIcon }).addTo(map);
        routeLayers[alg].push(arrow);
    }
}

/* API call */
async function callRoute(alg, useTraffic) {
    if(markers.length < 2) { 
        alert('‚ö†Ô∏è –≠—Ö–ª—ç–ª –±–æ–ª–æ–Ω —Ç”©–≥—Å–≥”©–ª –±–∞–π—Ä–ª—É—É–ª–∞–∞–≥“Ø–π –±–∞–π–Ω–∞.'); 
        return null; 
    }

    const src = markers[0].getLatLng(), dst = markers[1].getLatLng();
    const params = new URLSearchParams();
    params.set('src', `${src.lng},${src.lat}`);
    params.set('dst', `${dst.lng},${dst.lat}`);
    params.set('alg', alg);
    params.set('traffic', useTraffic ? 'true' : 'false');

    const url = '/route?' + params.toString();
    const res = await fetch(url);

    if(!res.ok) {
        const txt = await res.text().catch(() => res.statusText);
        throw new Error(txt || res.statusText);
    }

    return res.json();
}

/* Run button */
document.getElementById('runReplace').onclick = async () => {
    const alg = document.getElementById('algSelect').value;
    const useTraffic = document.getElementById('trafficToggle').checked;
    
    const algNames = {
        'dijkstra': 'Dijkstra',
        'bfs': 'BFS',
        'dfs': 'DFS'
    };
    const algName = algNames[alg] || alg;

    const trafficText = useTraffic ? ' (üö¶ –ó–∞–º—ã–Ω —Ö”©–¥”©–ª–≥”©”©–Ω—Ç—ç–π)' : '';
    const progressInterval = showProgress(`${algName}${trafficText} –∞–∂–∏–ª–ª–∞–∂ –±–∞–π–Ω–∞...`);
    document.getElementById('result').innerText = `‚è≥ ${algName} —Ç–æ–æ—Ü–æ–æ–ª–∂ –±–∞–π–Ω–∞...`;

    try {
        const data = await callRoute(alg, useTraffic);
        hideProgress(progressInterval);
        
        if(!data) return;
        
        if(data.error) {
            document.getElementById('result').innerHTML = `<strong style="color: #f5424e;">‚ö†Ô∏è –ê–ª–¥–∞–∞:</strong> ${data.message || data.error}`;
            return;
        }

        const color = colorForAlg(data.algorithm);
        
        const entry = {
            algorithm: data.algorithm,
            path: data.path,
            steps: data.steps,
            distance: data.distance || null,
            time: data.time || null,
            traffic: data.traffic || false,
            travel_time: data.travel_time || null,
            visible: true,
            color
        };

        resultsStore[data.algorithm] = entry;
        
        renderSavedList();
        redrawAllVisible();
        updateChartFromStore();

        // Clear markers
        markers.forEach(m => map.removeLayer(m));
        markers = [];

        let successMsg = `<strong style="color: #4caf50;">‚úì</strong> ${entry.algorithm}${entry.traffic ? ' üö¶' : ''}`;
        if(entry.time) successMsg += ` ‚Äî ‚è±Ô∏è ${entry.time}ms`;
        if(entry.steps) successMsg += ` | üë£ ${entry.steps}`;
        if(entry.distance) successMsg += ` | üìè ${Math.round(entry.distance)}–º`;
        if(entry.travel_time) successMsg += ` | üö¶ ${Math.round(entry.travel_time)}`;
        
        document.getElementById('result').innerHTML = successMsg;
    } catch (err) {
        hideProgress(progressInterval);
        alert('‚ùå ' + err.message);
        document.getElementById('result').innerHTML = `<strong style="color: #f5424e;">–ê–ª–¥–∞–∞:</strong> ${err.message}`;
    }
};

/* Compare button */
document.getElementById('compare').onclick = async () => {
    if(markers.length < 2) { 
        alert('‚ö†Ô∏è –≠—Ö–ª—ç–ª –±–æ–ª–æ–Ω —Ç”©–≥—Å–≥”©–ª –±–∞–π—Ä–ª—É—É–ª–∞–∞–≥“Ø–π –±–∞–π–Ω–∞.'); 
        return; 
    }

    const useTraffic = document.getElementById('trafficToggle').checked;
    const trafficText = useTraffic ? ' (üö¶ –ó–∞–º—ã–Ω —Ö”©–¥”©–ª–≥”©”©–Ω—Ç—ç–π)' : '';

    const progressInterval = showProgress(`‚öñÔ∏è 3 –∞–ª–≥–æ—Ä–∏—Ç–º${trafficText} —Ö–∞—Ä—å—Ü—É—É–ª–∂ –±–∞–π–Ω–∞...`);
    document.getElementById('result').innerText = '‚è≥ –•–∞—Ä—å—Ü—É—É–ª–∞–ª—Ç –∞–∂–∏–ª–ª–∞–∂ –±–∞–π–Ω–∞...';

    try {
        const src = markers[0].getLatLng(), dst = markers[1].getLatLng();
        const url = `/compare?src=${src.lng},${src.lat}&dst=${dst.lng},${dst.lat}&traffic=${useTraffic ? 'true' : 'false'}`;
        const res = await fetch(url);
        
        hideProgress(progressInterval);
        
        if(!res.ok) { 
            const t = await res.text().catch(() => res.statusText); 
            throw new Error(t || res.statusText); 
        }
        
        const arr = await res.json();
        
        for(const r of arr) {
            if(!r || r.error) continue;
            const algName = r.algorithm;
            const color = colorForAlg(algName);
            const entry = { 
                algorithm: algName,
                path: r.path,
                steps: r.steps,
                distance: r.distance || null,
                time: r.time || null,
                traffic: r.traffic || false,
                travel_time: r.travel_time || null,
                visible: true, 
                color 
            };
            resultsStore[algName] = entry;
        }
        
        markers.forEach(m => map.removeLayer(m)); 
        markers = [];

        renderSavedList(); 
        redrawAllVisible(); 
        updateChartFromStore();
        
        // Show comparison summary
        const times = arr.filter(r => !r.error).map(r => `${r.algorithm}: ${r.time}ms`).join(', ');
        document.getElementById('result').innerHTML = `<strong style="color: #4caf50;">‚úì</strong> –•–∞—Ä—å—Ü—É—É–ª–∞–ª—Ç –¥—É—É—Å—Å–∞–Ω${trafficText}<br><small style="color: #90caf9;">${times}</small>`;
    } catch(err) {
        hideProgress(progressInterval);
        alert('‚ùå ' + err.message);
        document.getElementById('result').innerHTML = `<strong style="color: #f5424e;">–ê–ª–¥–∞–∞:</strong> ${err.message}`;
    }
};

/* Clear button */
document.getElementById('clear').onclick = () => {
    for(const alg in routeLayers) routeLayers[alg].forEach(l => map.removeLayer(l));
    routeLayers = {};
    resultsStore = {};
    renderSavedList();
    markers.forEach(m => map.removeLayer(m)); 
    markers = [];
    chart.data.labels = []; 
    chart.data.datasets[0].data = []; 
    chart.update();
    document.getElementById('result').innerText = 'üóëÔ∏è –ë“Ø—Ö –∑“Ø–π–ª —Ü—ç–≤—ç—Ä–ª—ç–≥–¥–ª—ç—ç';
};

// Initialize
renderSavedList();
updateChartFromStore();
</script>
</body>
</html>