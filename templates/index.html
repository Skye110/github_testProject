<!DOCTYPE html>
<html lang="mn">
<head>
<meta charset="utf-8" />
<title>UB Route Finder</title>
<link rel="stylesheet" href="/static/style.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div id="map"></div>

<div id="control-panel">
    <h2>ğŸ—ºï¸ Route Finder</h2>

    <div class="control-group">
        <label for="algSelect">Algorithm</label>
        <select id="algSelect">
            <option value="dijkstra">Dijkstra</option>
            <option value="bfs">BFS</option>
            <option value="dfs">DFS</option>
        </select>
    </div>

    <div class="control-group">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="trafficToggle" style="width: auto; cursor: pointer;">
            <span>ğŸš¦ Enable Traffic Simulation</span>
        </label>
    </div>

    <div class="control-group" id="trafficControls" style="display: none;">
        <label for="timeSelect">Time of Day</label>
        <select id="timeSelect">
            <option value="-1">Current Time</option>
            <option value="8">08:00 - Morning Rush</option>
            <option value="12">12:00 - Midday</option>
            <option value="18">18:00 - Evening Rush</option>
            <option value="22">22:00 - Night</option>
        </select>
    </div>

    <div class="button-group">
        <button id="runReplace" class="btn-primary">â–¶ï¸ Run Algorithm</button>
        <button id="compare" class="btn-success">âš–ï¸ Compare All</button>
        <button id="clear" class="btn-danger">ğŸ—‘ï¸ Clear</button>
    </div>

    <div id="status" class="status-box">
        <div id="result">ğŸ“ Click on map: Start â†’ End</div>
        <div id="progress" style="display:none; margin-top: 8px;">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="progressText"></div>
        </div>
    </div>

    <div class="panel-block">
        <h4>ğŸ“Š Results</h4>
        <div id="savedList" class="saved-list"></div>
    </div>

    <div class="panel-block">
        <h4>â±ï¸ Performance</h4>
        <canvas id="perfChart" width="280" height="140"></canvas>
    </div>
</div>

<script>
const map = L.map('map').setView([47.918, 106.917], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
    maxZoom: 18,
    attribution: 'Â© OpenStreetMap'
}).addTo(map);

let markers = [];
let routeLayers = {};
let resultsStore = {};

const algorithmNames = {
    'dijkstra': 'Dijkstra',
    'bfs': 'BFS',
    'dfs': 'DFS'
};

function colorForAlg(alg) {
    const colors = {
        'Dijkstra': '#e74c3c',
        'BFS': '#3498db',
        'DFS': '#2ecc71'
    };
    return colors[alg] || '#888';
}

document.getElementById('trafficToggle').onchange = function() {
    document.getElementById('trafficControls').style.display = this.checked ? 'block' : 'none';
};

const ctx = document.getElementById('perfChart').getContext('2d');
const chart = new Chart(ctx, { 
    type: 'bar', 
    data: { labels: [], datasets: [{ label: 'Time (ms)', data: [], backgroundColor: [] }] }, 
    options: { 
        responsive: true, 
        maintainAspectRatio: false,
        scales: { 
            y: { beginAtZero: true, title: { display: true, text: 'ms', color: '#d3e8ff' }, ticks: { color: '#d3e8ff' }, grid: { color: 'rgba(255,255,255,0.1)' } },
            x: { ticks: { color: '#d3e8ff' }, grid: { color: 'rgba(255,255,255,0.1)' } }
        },
        plugins: { legend: { display: false } }
    } 
});

function updateChart() {
    const keys = Object.keys(resultsStore);
    chart.data.labels = keys;
    chart.data.datasets[0].data = keys.map(k => resultsStore[k].time || 0);
    chart.data.datasets[0].backgroundColor = keys.map(k => resultsStore[k].color);
    chart.update();
}

function showProgress(text) {
    document.getElementById('progress').style.display = 'block';
    document.getElementById('progressText').innerText = text;
    let width = 0;
    const fill = document.getElementById('progressFill');
    const interval = setInterval(() => { width += 5; if(width > 90) width = 90; fill.style.width = width + '%'; }, 300);
    return interval;
}

function hideProgress(interval) {
    clearInterval(interval);
    document.getElementById('progressFill').style.width = '100%';
    setTimeout(() => { document.getElementById('progress').style.display = 'none'; document.getElementById('progressFill').style.width = '0%'; }, 500);
}

function addMarker(latlng, label) {
    const icon = label === 'Start' ? 'ğŸŸ¢' : 'ğŸ”´';
    const m = L.marker(latlng, {
        icon: L.divIcon({ className: 'custom-marker', html: `<div style="font-size: 24px;">${icon}</div>`, iconSize: [30, 30], iconAnchor: [15, 15] })
    }).addTo(map).bindPopup(`<b>${label}</b>`).openPopup();
    markers.push(m);
}

map.on('click', e => {
    if(markers.length === 0) { 
        addMarker(e.latlng, 'Start'); 
        document.getElementById('result').innerText = 'âœ… Start set. Click End.'; 
        return; 
    }
    if(markers.length === 1) { 
        addMarker(e.latlng, 'End'); 
        document.getElementById('result').innerText = 'âœ… End set. Run algorithm.'; 
        return; 
    }
    markers.forEach(m => map.removeLayer(m)); 
    markers = []; 
    addMarker(e.latlng, 'Start'); 
    document.getElementById('result').innerText = 'ğŸ”„ New start. Click End.';
});

function renderSavedList() {
    const box = document.getElementById('savedList'); 
    box.innerHTML = '';
    const keys = Object.keys(resultsStore);
    if(keys.length === 0) { 
        box.innerHTML = '<div style="color: #888; text-align: center; padding: 12px;">No results</div>'; 
        return; 
    }
    keys.forEach(alg => {
        const r = resultsStore[alg];
        const row = document.createElement('div'); 
        row.className = 'saved-row';
        const timeText = r.time ? `â±ï¸ ${r.time}ms` : '';
        const distText = r.distance ? ` | ğŸ“ ${Math.round(r.distance)}m` : '';
        const stepsText = r.steps ? ` | ğŸ‘£ ${r.steps}` : '';
        row.innerHTML = `<div class="saved-left"><span class="swatch" style="background:${r.color}"></span><div><div class="lbl">${alg}${r.traffic ? ' ğŸš¦' : ''}</div><div class="meta">${timeText}${stepsText}${distText}</div></div></div><div class="saved-actions"><button data-alg="${alg}" class="toggle-btn btn-sm">${r.visible ? 'ğŸ‘ï¸':'ğŸ‘ï¸â€ğŸ—¨ï¸'}</button><button data-alg="${alg}" class="delete-btn btn-sm">Ã—</button></div>`;
        box.appendChild(row);
    });
    box.querySelectorAll('.toggle-btn').forEach(btn => { 
        btn.onclick = e => { 
            const alg = e.target.dataset.alg; 
            resultsStore[alg].visible = !resultsStore[alg].visible; 
            e.target.innerText = resultsStore[alg].visible ? 'ğŸ‘ï¸':'ğŸ‘ï¸â€ğŸ—¨ï¸'; 
            redrawAll(); 
        }; 
    });
    box.querySelectorAll('.delete-btn').forEach(btn => { 
        btn.onclick = e => { 
            const alg = e.target.dataset.alg; 
            if(routeLayers[alg]) routeLayers[alg].forEach(l => map.removeLayer(l)); 
            delete routeLayers[alg]; 
            delete resultsStore[alg]; 
            renderSavedList(); 
            updateChart(); 
        }; 
    });
}

function redrawAll() {
    for(const alg in routeLayers) { 
        routeLayers[alg].forEach(l => map.removeLayer(l)); 
    }
    routeLayers = {};
    for(const alg in resultsStore) {
        if(!resultsStore[alg].visible) continue;
        const r = resultsStore[alg];
        if(!r.path || r.path.length === 0) continue;
        routeLayers[alg] = [];
        const latlngs = r.path.map(pt => [pt[1], pt[0]]);
        const poly = L.polyline(latlngs, { color: r.color, weight: 5, opacity: 0.8 }).addTo(map);
        const info = `<b>${alg}</b>${r.time ? `<br>â±ï¸ ${r.time}ms` : ''}${r.distance ? `<br>ğŸ“ ${Math.round(r.distance)}m` : ''}<br>ğŸ‘£ ${r.steps}`;
        poly.bindPopup(info);
        routeLayers[alg].push(poly);
        routeLayers[alg].push(L.circleMarker(latlngs[0], { radius: 7, fillColor: '#2ecc71', color: '#fff', weight: 2, fillOpacity: 1 }).addTo(map));
        routeLayers[alg].push(L.circleMarker(latlngs[latlngs.length-1], { radius: 7, fillColor: '#e74c3c', color: '#fff', weight: 2, fillOpacity: 1 }).addTo(map));
    }
}

async function callRoute(alg, useTraffic, timeHour) {
    if(markers.length < 2) { 
        alert('âš ï¸ Set start and end points'); 
        return null; 
    }
    const src = markers[0].getLatLng(), dst = markers[1].getLatLng();
    const params = new URLSearchParams();
    params.set('src', `${src.lng},${src.lat}`);
    params.set('dst', `${dst.lng},${dst.lat}`);
    params.set('alg', alg);
    params.set('traffic', useTraffic ? 'true' : 'false');
    if(timeHour >= 0) params.set('time_hour', timeHour);
    const res = await fetch('/route?' + params);
    if(!res.ok) { 
        const txt = await res.text().catch(() => res.statusText); 
        throw new Error(txt || res.statusText); 
    }
    return res.json();
}

document.getElementById('runReplace').onclick = async () => {
    const alg = document.getElementById('algSelect').value;
    const useTraffic = document.getElementById('trafficToggle').checked;
    const timeSelect = document.getElementById('timeSelect').value;
    const timeHour = timeSelect === '-1' ? -1 : parseInt(timeSelect);
    const algName = algorithmNames[alg] || alg;
    const progressInterval = showProgress(`Running ${algName}...`);
    document.getElementById('result').innerText = `â³ Computing ${algName}...`;
    try {
        const data = await callRoute(alg, useTraffic, timeHour);
        hideProgress(progressInterval);
        if(!data) return;
        if(data.error) { 
            document.getElementById('result').innerHTML = `<strong style="color: #f5424e;">âš ï¸ Error:</strong> ${data.message || data.error}`; 
            return; 
        }
        const displayName = algorithmNames[data.algorithm] || data.algorithm;
        const entry = { 
            algorithm: displayName, 
            path: data.path, 
            steps: data.steps, 
            distance: data.distance || null, 
            time: data.time || null, 
            traffic: data.traffic || false, 
            visible: true, 
            color: colorForAlg(displayName) 
        };
        resultsStore[displayName] = entry;
        renderSavedList(); 
        redrawAll(); 
        updateChart();
        markers.forEach(m => map.removeLayer(m)); 
        markers = [];
        let msg = `<strong style="color: #4caf50;">âœ”</strong> ${entry.algorithm}`;
        if(entry.time) msg += ` â€” â±ï¸ ${entry.time}ms`;
        if(entry.steps) msg += ` | ğŸ‘£ ${entry.steps}`;
        if(entry.distance) msg += ` | ğŸ“ ${Math.round(entry.distance)}m`;
        document.getElementById('result').innerHTML = msg;
    } catch (err) { 
        hideProgress(progressInterval); 
        alert('âŒ ' + err.message); 
        document.getElementById('result').innerHTML = `<strong style="color: #f5424e;">Error:</strong> ${err.message}`; 
    }
};

document.getElementById('compare').onclick = async () => {
    if(markers.length < 2) { 
        alert('âš ï¸ Set start and end points'); 
        return; 
    }
    const useTraffic = document.getElementById('trafficToggle').checked;
    const timeSelect = document.getElementById('timeSelect').value;
    const timeHour = timeSelect === '-1' ? -1 : parseInt(timeSelect);
    const progressInterval = showProgress('âš–ï¸ Comparing algorithms...');
    document.getElementById('result').innerText = 'â³ Comparing...';
    try {
        const src = markers[0].getLatLng(), dst = markers[1].getLatLng();
        let url = `/compare?src=${src.lng},${src.lat}&dst=${dst.lng},${dst.lat}&traffic=${useTraffic ? 'true' : 'false'}`;
        if(timeHour >= 0) url += `&time_hour=${timeHour}`;
        const res = await fetch(url);
        hideProgress(progressInterval);
        if(!res.ok) { 
            const t = await res.text().catch(() => res.statusText); 
            throw new Error(t || res.statusText); 
        }
        const arr = await res.json();
        for(const r of arr) {
            if(!r || r.error) continue;
            const algName = algorithmNames[r.algorithm] || r.algorithm;
            resultsStore[algName] = { 
                algorithm: algName, 
                path: r.path, 
                steps: r.steps, 
                distance: r.distance || null, 
                time: r.time || null, 
                traffic: r.traffic || false, 
                visible: true, 
                color: colorForAlg(algName) 
            };
        }
        markers.forEach(m => map.removeLayer(m)); 
        markers = [];
        renderSavedList(); 
        redrawAll(); 
        updateChart();
        const times = arr.filter(r => !r.error).map(r => `${algorithmNames[r.algorithm]}: ${r.time}ms`).join(', ');
        document.getElementById('result').innerHTML = `<strong style="color: #4caf50;">âœ”</strong> Comparison complete<br><small>${times}</small>`;
    } catch(err) { 
        hideProgress(progressInterval); 
        alert('âŒ ' + err.message); 
        document.getElementById('result').innerHTML = `<strong style="color: #f5424e;">Error:</strong> ${err.message}`; 
    }
};

document.getElementById('clear').onclick = () => {
    for(const alg in routeLayers) routeLayers[alg].forEach(l => map.removeLayer(l));
    routeLayers = {}; 
    resultsStore = {}; 
    renderSavedList();
    markers.forEach(m => map.removeLayer(m)); 
    markers = [];
    chart.data.labels = []; 
    chart.data.datasets[0].data = []; 
    chart.update();
    document.getElementById('result').innerText = 'ğŸ—‘ï¸ Cleared';
};

renderSavedList(); 
updateChart();
</script>
</body>
</html>