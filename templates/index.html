<!DOCTYPE html>
<html lang="mn">
<head>
<meta charset="utf-8" />
<title>UB Route Finder ‚Äì Traffic Flow</title>
<link rel="stylesheet" href="/static/style.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div id="map"></div>

<div id="control-panel">
    <h2>üó∫Ô∏è –ê–ª–≥–æ—Ä–∏—Ç–º –•–∞—Ä—å—Ü—É—É–ª–∞—Ö</h2>

    <div class="control-group">
        <label for="algSelect">–ê–ª–≥–æ—Ä–∏—Ç–º —Å–æ–Ω–≥–æ—Ö</label>
        <select id="algSelect">
            <option value="dijkstra">Dijkstra - –•–∞–º–≥–∏–π–Ω –±–æ–≥–∏–Ω–æ –∑–∞–º</option>
            <option value="bfs">BFS - –¶”©”©–Ω –∞–ª—Ö–∞–º—Ç–∞–π</option>
            <option value="dfs">DFS - –•—É—Ä–¥–∞–Ω –æ–ª–æ—Ö</option>
        </select>
        <small style="color: #90caf9; font-size: 11px; margin-top: 4px; display: block;">
            üí° Dijkstra: –ú–µ—Ç—Ä—ç—ç—Ä —Ö–∞–º–≥–∏–π–Ω –±–æ–≥–∏–Ω–æ | BFS: –¶”©”©–Ω —É—É–ª–∑–≤–∞—Ä | DFS: –Ø–º–∞—Ä —á –∑–∞–º
        </small>
    </div>

    <div class="control-group">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="trafficToggle" style="width: auto; cursor: pointer;">
            <span>üö¶ –ó–∞–º—ã–Ω —Ö”©–¥”©–ª–≥”©”©–Ω–∏–π –∞—á–∞–∞–ª–ª—ã–≥ —Ç–æ–æ—Ü–æ—Ö</span>
        </label>
    </div>

    <div class="control-group" id="trafficControls" style="display: none;">
        <label for="timeSelect">üïê –¶–∞–≥–∏–π–Ω —Å–æ–Ω–≥–æ–ª—Ç</label>
        <select id="timeSelect">
            <option value="-1">–û–¥–æ–æ–≥–∏–π–Ω —Ü–∞–≥</option>
            <option value="8">08:00 - ”®–≥–ª”©”©–Ω–∏–π –∑–∞–≤–≥“Ø–π —Ü–∞–≥</option>
            <option value="12">12:00 - ”®–¥—Ä–∏–π–Ω —Ü–∞–≥</option>
            <option value="18">18:00 - –û—Ä–æ–π–Ω –∑–∞–≤–≥“Ø–π —Ü–∞–≥</option>
            <option value="22">22:00 - –®”©–Ω–∏–π–Ω —Ü–∞–≥</option>
        </select>
    </div>

    <div class="button-group">
        <button id="runReplace" class="btn-primary">‚ñ∂Ô∏è –î“Ø–π—Ü—ç—Ç–≥—ç—Ö</button>
        <button id="compare" class="btn-success">‚öñÔ∏è –•–∞—Ä—å—Ü—É—É–ª–∞—Ö (3 –∞–ª–≥–æ—Ä–∏—Ç–º)</button>
        <button id="clear" class="btn-danger">üóëÔ∏è –¶—ç–≤—ç—Ä–ª—ç—Ö</button>
    </div>

    <div id="status" class="status-box">
        <div id="result">üìç –ì–∞–∑—Ä—ã–Ω –∑—É—Ä–∞–≥ –¥—ç—ç—Ä –≠—Ö–ª—ç–ª, –¥–∞—Ä–∞–∞ –¢”©–≥—Å–≥”©–ª-–∏–π–≥ –¥–∞—Ä–Ω–∞ —É—É</div>
        <div id="progress" style="display:none; margin-top: 8px;">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="progressText"></div>
        </div>
    </div>

    <div class="panel-block">
        <h4>üìä –•–∞–¥–≥–∞–ª—Å–∞–Ω “Ø—Ä –¥“Ø–Ω</h4>
        <div id="savedList" class="saved-list"></div>
    </div>

    <div class="panel-block">
        <h4>‚è±Ô∏è –î“Ø–π—Ü—ç—Ç–≥—ç–ª–∏–π–Ω —Ö–∞—Ä—å—Ü—É—É–ª–∞–ª—Ç</h4>
        <canvas id="perfChart" width="280" height="140"></canvas>
    </div>

    <div class="panel-block">
        <h4>‚ÑπÔ∏è –ê–ª–≥–æ—Ä–∏—Ç–º—ã–Ω —Ç–∞–π–ª–±–∞—Ä</h4>
        <div style="font-size: 12px; line-height: 1.6; color: #d3e8ff;">
            <p><strong>Dijkstra:</strong> –•–∞–º–≥–∏–π–Ω –±–æ–≥–∏–Ω–æ –∑–∞–º—ã–≥ –æ–ª–Ω–æ (–º–µ—Ç—Ä)</p>
            <p><strong>BFS:</strong> –•–∞–º–≥–∏–π–Ω —Ü”©”©–Ω —É—É–ª–∑–≤–∞—Ä—Ç–∞–π</p>
            <p><strong>DFS:</strong> –•—É—Ä–¥–∞–Ω —è–º–∞—Ä —á –∑–∞–º—ã–≥ –æ–ª–Ω–æ</p>
        </div>
    </div>
</div>

<script>
const map = L.map('map').setView([47.918, 106.917], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
    maxZoom: 18,
    attribution: '¬© OpenStreetMap contributors'
}).addTo(map);

let markers = [];
let routeLayers = {};
let resultsStore = {};

const algorithmNames = {
    'dijkstra': 'Dijkstra',
    'bfs': 'BFS',
    'dfs': 'DFS',
    'Dijkstra': 'Dijkstra',
    'BFS': 'BFS',
    'DFS': 'DFS'
};

function colorForAlg(alg) {
    const colors = {
        'Dijkstra': '#e74c3c',
        'BFS': '#3498db',
        'DFS': '#2ecc71'
    };
    return colors[alg] || '#888';
}

document.getElementById('trafficToggle').onchange = function() {
    document.getElementById('trafficControls').style.display = this.checked ? 'block' : 'none';
};

const ctx = document.getElementById('perfChart').getContext('2d');
const chart = new Chart(ctx, { 
    type: 'bar', 
    data: { labels: [], datasets: [{ label: '–•—É–≥–∞—Ü–∞–∞ (ms)', data: [], backgroundColor: [] }] }, 
    options: { 
        responsive: true, 
        maintainAspectRatio: false,
        scales: { 
            y: { beginAtZero: true, title: { display: true, text: '–º—Å', color: '#d3e8ff' }, ticks: { color: '#d3e8ff' }, grid: { color: 'rgba(255,255,255,0.1)' } },
            x: { ticks: { color: '#d3e8ff' }, grid: { color: 'rgba(255,255,255,0.1)' } }
        },
        plugins: { legend: { display: false } }
    } 
});

function updateChartFromStore() {
    const keys = Object.keys(resultsStore);
    chart.data.labels = keys;
    chart.data.datasets[0].data = keys.map(k => resultsStore[k].time || 0);
    chart.data.datasets[0].backgroundColor = keys.map(k => resultsStore[k].color);
    chart.update();
}

function showProgress(text) {
    document.getElementById('progress').style.display = 'block';
    document.getElementById('progressText').innerText = text;
    let width = 0;
    const fill = document.getElementById('progressFill');
    const interval = setInterval(() => { width += 5; if(width > 90) width = 90; fill.style.width = width + '%'; }, 300);
    return interval;
}

function hideProgress(interval) {
    clearInterval(interval);
    document.getElementById('progressFill').style.width = '100%';
    setTimeout(() => { document.getElementById('progress').style.display = 'none'; document.getElementById('progressFill').style.width = '0%'; }, 500);
}

function addMarker(latlng, label) {
    const icon = label === '–≠—Ö–ª—ç–ª' ? 'üü¢' : 'üî¥';
    const m = L.marker(latlng, {
        icon: L.divIcon({ className: 'custom-marker', html: `<div style="font-size: 24px;">${icon}</div>`, iconSize: [30, 30], iconAnchor: [15, 15] })
    }).addTo(map).bindPopup(`<b>${label}</b>`).openPopup();
    markers.push(m);
}

map.on('click', e => {
    if(markers.length === 0) { addMarker(e.latlng, '–≠—Ö–ª—ç–ª'); document.getElementById('result').innerText = '‚úÖ –≠—Ö–ª—ç–ª. –¢”©–≥—Å–≥”©–ª —Å–æ–Ω–≥–æ–Ω–æ —É—É.'; return; }
    if(markers.length === 1) { addMarker(e.latlng, '–¢”©–≥—Å–≥”©–ª'); document.getElementById('result').innerText = '‚úÖ –¢”©–≥—Å–≥”©–ª. "–î“Ø–π—Ü—ç—Ç–≥—ç—Ö" –¥–∞—Ä–Ω–∞ —É—É.'; return; }
    markers.forEach(m => map.removeLayer(m)); markers = []; addMarker(e.latlng, '–≠—Ö–ª—ç–ª'); document.getElementById('result').innerText = 'üîÑ –®–∏–Ω—ç —ç—Ö–ª—ç–ª. –¢”©–≥—Å–≥”©–ª —Å–æ–Ω–≥–æ–Ω–æ —É—É.';
});

function renderSavedList() {
    const box = document.getElementById('savedList'); box.innerHTML = '';
    const keys = Object.keys(resultsStore);
    if(keys.length === 0) { box.innerHTML = '<div style="color: #888; text-align: center; padding: 12px;">–•–∞–¥–≥–∞–ª—Å–∞–Ω “Ø—Ä –¥“Ø–Ω –∞–ª–≥–∞</div>'; return; }
    keys.forEach(alg => {
        const r = resultsStore[alg];
        const row = document.createElement('div'); row.className = 'saved-row';
        const timeText = r.time ? `‚è±Ô∏è ${r.time}ms` : '';
        const distText = r.distance ? ` | üìè ${Math.round(r.distance)}–º` : '';
        const stepsText = r.steps ? ` | üë£ ${r.steps}` : '';
        row.innerHTML = `<div class="saved-left"><span class="swatch" style="background:${r.color}"></span><div><div class="lbl">${alg}${r.traffic ? ' üö¶' : ''}</div><div class="meta">${timeText}${stepsText}${distText}</div></div></div><div class="saved-actions"><button data-alg="${alg}" class="toggle-btn btn-sm">${r.visible ? 'üëÅÔ∏è –ù—É—É—Ö':'üëÅÔ∏è –•–∞—Ä–∞—Ö'}</button><button data-alg="${alg}" class="delete-btn btn-sm">√ó</button></div>`;
        box.appendChild(row);
    });
    box.querySelectorAll('.toggle-btn').forEach(btn => { btn.onclick = e => { const alg = e.target.dataset.alg; resultsStore[alg].visible = !resultsStore[alg].visible; e.target.innerText = resultsStore[alg].visible ? 'üëÅÔ∏è –ù—É—É—Ö':'üëÅÔ∏è –•–∞—Ä–∞—Ö'; redrawAllVisible(); }; });
    box.querySelectorAll('.delete-btn').forEach(btn => { btn.onclick = e => { const alg = e.target.dataset.alg; if(routeLayers[alg]) routeLayers[alg].forEach(l => map.removeLayer(l)); delete routeLayers[alg]; delete resultsStore[alg]; renderSavedList(); updateChartFromStore(); }; });
}

function redrawAllVisible() {
    for(const alg in routeLayers) { routeLayers[alg].forEach(l => map.removeLayer(l)); }
    routeLayers = {};
    for(const alg in resultsStore) {
        if(!resultsStore[alg].visible) continue;
        const r = resultsStore[alg];
        if(!r.path || r.path.length === 0) continue;
        routeLayers[alg] = [];
        const latlngs = r.path.map(pt => [pt[1], pt[0]]);
        const poly = L.polyline(latlngs, { color: r.color, weight: 5, opacity: 0.8 }).addTo(map);
        const info = `<b>${alg}</b>${r.time ? `<br>‚è±Ô∏è ${r.time}ms` : ''}${r.distance ? `<br>üìè ${Math.round(r.distance)}–º` : ''}<br>üë£ ${r.steps}`;
        poly.bindPopup(info);
        routeLayers[alg].push(poly);
        routeLayers[alg].push(L.circleMarker(latlngs[0], { radius: 7, fillColor: '#2ecc71', color: '#fff', weight: 2, fillOpacity: 1 }).addTo(map));
        routeLayers[alg].push(L.circleMarker(latlngs[latlngs.length-1], { radius: 7, fillColor: '#e74c3c', color: '#fff', weight: 2, fillOpacity: 1 }).addTo(map));
    }
}

async function callRoute(alg, useTraffic, timeHour) {
    if(markers.length < 2) { alert('‚ö†Ô∏è –≠—Ö–ª—ç–ª –±–æ–ª–æ–Ω —Ç”©–≥—Å–≥”©–ª –±–∞–π—Ä–ª—É—É–ª–∞–∞–≥“Ø–π.'); return null; }
    const src = markers[0].getLatLng(), dst = markers[1].getLatLng();
    const params = new URLSearchParams();
    params.set('src', `${src.lng},${src.lat}`);
    params.set('dst', `${dst.lng},${dst.lat}`);
    params.set('alg', alg);
    params.set('traffic', useTraffic ? 'true' : 'false');
    if(timeHour >= 0) params.set('time_hour', timeHour);
    const res = await fetch('/route?' + params);
    if(!res.ok) { const txt = await res.text().catch(() => res.statusText); throw new Error(txt || res.statusText); }
    return res.json();
}

document.getElementById('runReplace').onclick = async () => {
    const alg = document.getElementById('algSelect').value;
    const useTraffic = document.getElementById('trafficToggle').checked;
    const timeSelect = document.getElementById('timeSelect').value;
    const timeHour = timeSelect === '-1' ? -1 : parseInt(timeSelect);
    const algName = algorithmNames[alg] || alg;
    const progressInterval = showProgress(`${algName} –∞–∂–∏–ª–ª–∞–∂ –±–∞–π–Ω–∞...`);
    document.getElementById('result').innerText = `‚è≥ ${algName} —Ç–æ–æ—Ü–æ–æ–ª–∂ –±–∞–π–Ω–∞...`;
    try {
        const data = await callRoute(alg, useTraffic, timeHour);
        hideProgress(progressInterval);
        if(!data) return;
        if(data.error) { document.getElementById('result').innerHTML = `<strong style="color: #f5424e;">‚ö†Ô∏è –ê–ª–¥–∞–∞:</strong> ${data.message || data.error}`; return; }
        const displayName = algorithmNames[data.algorithm] || data.algorithm;
        const entry = { algorithm: displayName, path: data.path, steps: data.steps, distance: data.distance || null, time: data.time || null, traffic: data.traffic || false, travel_time: data.travel_time || null, visible: true, color: colorForAlg(displayName) };
        resultsStore[displayName] = entry;
        renderSavedList(); redrawAllVisible(); updateChartFromStore();
        markers.forEach(m => map.removeLayer(m)); markers = [];
        let msg = `<strong style="color: #4caf50;">‚úî</strong> ${entry.algorithm}`;
        if(entry.time) msg += ` ‚Äî ‚è±Ô∏è ${entry.time}ms`;
        if(entry.steps) msg += ` | üë£ ${entry.steps}`;
        if(entry.distance) msg += ` | üìè ${Math.round(entry.distance)}–º`;
        document.getElementById('result').innerHTML = msg;
    } catch (err) { hideProgress(progressInterval); alert('‚ùå ' + err.message); document.getElementById('result').innerHTML = `<strong style="color: #f5424e;">–ê–ª–¥–∞–∞:</strong> ${err.message}`; }
};

document.getElementById('compare').onclick = async () => {
    if(markers.length < 2) { alert('‚ö†Ô∏è –≠—Ö–ª—ç–ª –±–æ–ª–æ–Ω —Ç”©–≥—Å–≥”©–ª –±–∞–π—Ä–ª—É—É–ª–∞–∞–≥“Ø–π.'); return; }
    const useTraffic = document.getElementById('trafficToggle').checked;
    const timeSelect = document.getElementById('timeSelect').value;
    const timeHour = timeSelect === '-1' ? -1 : parseInt(timeSelect);
    const progressInterval = showProgress('‚öñÔ∏è 3 –∞–ª–≥–æ—Ä–∏—Ç–º —Ö–∞—Ä—å—Ü—É—É–ª–∂ –±–∞–π–Ω–∞...');
    document.getElementById('result').innerText = '‚è≥ –•–∞—Ä—å—Ü—É—É–ª–∞–ª—Ç...';
    try {
        const src = markers[0].getLatLng(), dst = markers[1].getLatLng();
        let url = `/compare?src=${src.lng},${src.lat}&dst=${dst.lng},${dst.lat}&traffic=${useTraffic ? 'true' : 'false'}`;
        if(timeHour >= 0) url += `&time_hour=${timeHour}`;
        const res = await fetch(url);
        hideProgress(progressInterval);
        if(!res.ok) { const t = await res.text().catch(() => res.statusText); throw new Error(t || res.statusText); }
        const arr = await res.json();
        for(const r of arr) {
            if(!r || r.error) continue;
            const algName = algorithmNames[r.algorithm] || r.algorithm;
            resultsStore[algName] = { algorithm: algName, path: r.path, steps: r.steps, distance: r.distance || null, time: r.time || null, traffic: r.traffic || false, travel_time: r.travel_time || null, visible: true, color: colorForAlg(algName) };
        }
        markers.forEach(m => map.removeLayer(m)); markers = [];
        renderSavedList(); redrawAllVisible(); updateChartFromStore();
        const times = arr.filter(r => !r.error).map(r => `${algorithmNames[r.algorithm]}: ${r.time}ms`).join(', ');
        document.getElementById('result').innerHTML = `<strong style="color: #4caf50;">‚úî</strong> –•–∞—Ä—å—Ü—É—É–ª–∞–ª—Ç –¥—É—É—Å–∞–Ω<br><small>${times}</small>`;
    } catch(err) { hideProgress(progressInterval); alert('‚ùå ' + err.message); document.getElementById('result').innerHTML = `<strong style="color: #f5424e;">–ê–ª–¥–∞–∞:</strong> ${err.message}`; }
};

document.getElementById('clear').onclick = () => {
    for(const alg in routeLayers) routeLayers[alg].forEach(l => map.removeLayer(l));
    routeLayers = {}; resultsStore = {}; renderSavedList();
    markers.forEach(m => map.removeLayer(m)); markers = [];
    chart.data.labels = []; chart.data.datasets[0].data = []; chart.update();
    document.getElementById('result').innerText = 'üóëÔ∏è –ë“Ø—Ö –∑“Ø–π–ª —Ü—ç–≤—ç—Ä–ª—ç–≥–¥–ª—ç—ç';
};

renderSavedList(); updateChartFromStore();
</script>
</body>
</html>